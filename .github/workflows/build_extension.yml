name: Build DuckDB Spatial Extension

on:
  workflow_dispatch:
    inputs:
      spatial_repo:
        description: 'DuckDB Spatial Repository'
        required: true
        default: 'duckdb/duckdb-spatial'
      duckdb_spatial_ref:
        description: 'DuckDB Spatial Tag/Branch'
        required: true
        default: 'main'
      duckdb_ref:
        description: 'DuckDB Commit/Tag (leave empty to use submodule version)'
        required: false
        default: ''
  schedule:
    - cron: '0 4 * * 0'  # Runs at 04:00 UTC every Sunday

jobs:
  build-extension:
    name: Build Extension - ${{ matrix.platform }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - platform: linux-x64
            runner: ubuntu-latest
            vcpkg_triplet: x64-linux-release
            artifact_name: spatial-extension-linux-x64
          - platform: linux-arm64
            runner: ubuntu-24.04-arm
            vcpkg_triplet: arm64-linux-release
            artifact_name: spatial-extension-linux-arm64
          - platform: macos-arm64
            runner: macos-14
            vcpkg_triplet: arm64-osx-release
            artifact_name: spatial-extension-macos-arm64
          - platform: windows-x64
            runner: windows-latest
            vcpkg_triplet: x64-windows-static-md-release
            artifact_name: spatial-extension-windows-x64
    
    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
      VCPKG_TOOLCHAIN_PATH: ${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake
      VCPKG_TARGET_TRIPLET: ${{ matrix.vcpkg_triplet }}
      VCPKG_HOST_TRIPLET: ${{ matrix.vcpkg_triplet }}
      GEN: ninja

    steps:
      - name: Install R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'

      - name: Install Build Tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build build-essential cmake git \
            libcurl4-openssl-dev libssl-dev

      - name: Install Build Tools (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install ninja cmake

      - name: Install Build Tools (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install ninja cmake -y

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ matrix.platform }}-duckdb
          max-size: 2G

      - name: Checkout DuckDB Spatial
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.spatial_repo || 'duckdb/duckdb-spatial' }}
          ref: ${{ inputs.duckdb_spatial_ref || 'main' }}
          path: duckdb-spatial
          submodules: 'recursive'
          fetch-depth: 0

      - name: Checkout DuckDB (Override Submodule)
        if: github.event.inputs.duckdb_ref != '' && github.event.inputs.duckdb_ref != 'auto'
        working-directory: duckdb-spatial/duckdb
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          MSYS_NO_PATHCONV: 1
        run: |
          # Ensure we have tags for git describe
          git fetch origin --tags --quiet

          REF="${{ github.event.inputs.duckdb_ref }}"
          echo "Resolving full SHA for DuckDB reference: $REF"

          # Resolve to 40-character SHA to avoid ambiguity and facilitate direct fetch
          FULL_SHA=$(gh api "/repos/duckdb/duckdb/commits/$REF" --jq '.sha' || echo "$REF")
          echo "Determined Full SHA: $FULL_SHA"

          # Fetch the specific commit directly into a local reference
          git fetch origin "+$FULL_SHA:refs/remotes/origin/target_sha" --quiet || echo "Direct fetch unsuccessful, checking local cache..."

          # Checkout the commit in detached HEAD state (quietly)
          git checkout -q --detach "$FULL_SHA"

          echo "DuckDB Version Checked Out:"
          git describe --tags --always

      - name: Verify DuckDB Submodule
        shell: bash
        run: |
          echo "Verifying DuckDB submodule..."
          echo "Contents of duckdb-spatial:"
          ls -la duckdb-spatial/
          echo ""
          echo "Contents of duckdb-spatial/duckdb:"
          ls -la duckdb-spatial/duckdb/ || echo "duckdb directory doesn't exist"
          echo ""
          echo "Contents of duckdb-spatial/duckdb/tools:"
          ls -la duckdb-spatial/duckdb/tools/ || echo "tools directory doesn't exist"
          echo ""

          if [ ! -d "duckdb-spatial/duckdb/tools/rpkg" ]; then
            echo "Error: DuckDB R package directory not found!"
            exit 1
          fi
          echo "DuckDB R package directory verified"

      - name: Build DuckDB R Package (Unix)
        if: runner.os != 'Windows'
        working-directory: duckdb-spatial/duckdb/tools/rpkg
        shell: bash
        run: |
          echo "Building DuckDB R package from source..."

          # Set up ccache for compilation (ccache-action already added it to PATH)
          export CCACHE_DIR="${{ github.workspace }}/.ccache"

          # Build the package (source tarball)
          R CMD build .

          # Install and build binary package
          PKG_NAME=$(ls duckdb_*.tar.gz)
          echo "Installing $PKG_NAME..."
          R CMD INSTALL --build "$PKG_NAME"

          # Collect artifacts
          mkdir -p ${{ github.workspace }}/r-packages
          mv duckdb_*.tar.gz ${{ github.workspace }}/r-packages/
          mv duckdb_*.tgz ${{ github.workspace }}/r-packages/ 2>/dev/null || true

          echo "R package built:"
          ls -lh ${{ github.workspace }}/r-packages/

      - name: Build DuckDB R Package (Windows)
        if: runner.os == 'Windows'
        working-directory: duckdb-spatial/duckdb/tools/rpkg
        shell: bash
        run: |
          echo "Building DuckDB R package from source..."

          # Build the package (source tarball)
          R CMD build .

          # Install and build binary package
          PKG_NAME=$(ls duckdb_*.tar.gz)
          echo "Installing $PKG_NAME..."
          R CMD INSTALL --build "$PKG_NAME"

          # Collect artifacts
          mkdir -p ${{ github.workspace }}/r-packages
          mv duckdb_*.tar.gz ${{ github.workspace }}/r-packages/
          mv duckdb_*.zip ${{ github.workspace }}/r-packages/ 2>/dev/null || true

          echo "R package built:"
          ls -lh ${{ github.workspace }}/r-packages/

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: ${{ github.workspace }}/vcpkg
          vcpkgJsonGlob: 'duckdb-spatial/vcpkg.json'

      - name: Build Extension (Release)
        working-directory: duckdb-spatial
        run: |
          # VCPKG_TOOLCHAIN_PATH, VCPKG_TARGET_TRIPLET, VCPKG_HOST_TRIPLET and GEN are set in env
          make release

      - name: List Output (Unix)
        if: runner.os != 'Windows'
        run: |
          ls -R duckdb-spatial/build/release/extension/spatial/

      - name: List Output (Windows)
        if: runner.os == 'Windows'
        run: |
          dir duckdb-spatial\build\release\extension\spatial\ /s

      - name: Upload Spatial Extension Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: duckdb-spatial/build/release/extension/spatial/spatial.duckdb_extension

      - name: Upload DuckDB R Package Artifact
        uses: actions/upload-artifact@v4
        with:
          name: duckdb-r-package-${{ matrix.platform }}
          path: r-packages/duckdb_*.*
